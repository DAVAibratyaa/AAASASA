{% extends "base.html" %}
{% block title %}laudos.ai - Resultado{% endblock %}

{% block content %}
<!-- DEBUG: Show raw laudo from Flask (in case the regex kills everything) -->
<div class="p-2 mb-4 bg-red-100 text-red-800">
  <strong>DEBUG RAW LAUDO:</strong> {{ laudo }}
</div>

<div x-data="resultPage()" class="space-y-6" x-init="init()">
  <header class="flex flex-col space-y-2">
    <h1 class="text-3xl font-extrabold text-primary">
      Resultado do Laudo
    </h1>
    <p class="text-sm text-gray-400">
      Visualize e gerencie o resultado do seu laudo de forma simples e segura.
    </p>
  </header>

  <div class="bg-white rounded-lg shadow p-6 space-y-4">
    <div class="flex space-x-4 border-b pb-2">
      <button 
        @click="activeTab = 'laudo'"
        :class="activeTab === 'laudo' ? 'border-b-2 border-blue-500 text-blue-500' : 'text-gray-600'"
        class="pb-1 font-medium"
      >Laudo Gerado
      </button>
      <button 
        @click="activeTab = 'editor'"
        :class="activeTab === 'editor' ? 'border-b-2 border-blue-500 text-blue-500' : 'text-gray-600'"
        class="pb-1 font-medium"
      >Editor de Laudo
      </button>
    </div>

    <!-- TAB: Laudo -->
    <div x-show="activeTab === 'laudo'" class="space-y-4">
      <div class="bg-gray-100 p-4 rounded whitespace-pre-wrap text-sm text-gray-800 max-h-64 overflow-y-auto"
           id="laudoView">
        <span x-text="cleanedLaudo"></span>
      </div>
      <div class="flex justify-end space-x-3">
        <button @click="copyLaudo()" class="bg-primary text-white px-3 py-1 rounded">Copiar</button>
        <button @click="activeTab='editor'" class="bg-secondary text-white px-3 py-1 rounded">Editar</button>
      </div>
    </div>

    <!-- TAB: Editor -->
    <div x-show="activeTab === 'editor'" class="space-y-4">
      <div class="bg-gray-50 p-3 rounded">
        <p>Edite abaixo:</p>
      </div>
      <textarea x-model="editorContent"
                @input="updateLength()"
                class="w-full h-40 p-2 border border-gray-300"></textarea>
      <div class="text-sm text-gray-500">
        Caracteres: <span x-text="editorLength"></span>
      </div>
      <div class="flex justify-end space-x-3">
        <button @click="copyEditor()" class="bg-primary text-white px-3 py-1 rounded">Copiar Editor</button>
        <button @click="saveLaudo()" class="bg-green-600 text-white px-3 py-1 rounded">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div x-show="showNotification" class="fixed bottom-4 right-4 bg-green-500 text-white rounded px-4 py-2 shadow"
       x-transition
       style="display:none;">
    <span x-text="notificationMessage"></span>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function resultPage() {
  return {
    activeTab: 'laudo',
    showNotification: false,
    notificationMessage: '',
    rawLaudo: `{{ laudo|escape|replace("\n","\\n") }}`,
    cleanedLaudo: '',
    editorContent: '',
    editorLength: 0,

    init() {
      // 1) Remove entire blocks <tag>...</tag>
      const step1 = this.rawLaudo.replace(/<[^>]+>[\s\S]*?<\/[^>]+>/g, '');
      // 2) Remove leftover single tags
      const step2 = step1.replace(/<[^>]*>/g, '');
      this.cleanedLaudo = step2.trim();

      this.editorContent = this.cleanedLaudo;
      this.updateLength();
    },
    updateLength() {
      this.editorLength = this.editorContent.length;
    },
    copyLaudo() {
      navigator.clipboard.writeText(this.cleanedLaudo)
        .then(() => this.fireNotice('Laudo copiado!'))
        .catch(() => this.fireNotice('Erro ao copiar laudo.'));
    },
    copyEditor() {
      navigator.clipboard.writeText(this.editorContent)
        .then(() => this.fireNotice('Copiado do editor!'))
        .catch(() => this.fireNotice('Erro ao copiar do editor.'));
    },
    saveLaudo() {
      fetch('{{ url_for("save_laudo") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ laudo: this.editorContent })
      })
      .then(r => r.json())
      .then(data => {
        if (data.error) this.fireNotice(data.error);
        else this.fireNotice(data.message || 'Laudo salvo!');
      })
      .catch(err => {
        console.error(err);
        this.fireNotice('Falha de rede ao salvar.');
      });
    },
    fireNotice(msg) {
      this.notificationMessage = msg;
      this.showNotification = true;
      setTimeout(() => this.showNotification = false, 2500);
    }
  }
}
</script>
{% endblock %}
